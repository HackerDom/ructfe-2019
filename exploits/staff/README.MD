# WRITEUP

## 1 vuln
Weak invite links in `chatEntity.js`
```js
chatSchema.plugin(autoIncrement.plugin, {
    model: 'Chat',
    field: 'inviteLink'
});
```
### [Exploit](./weak_invite_links.py)
### How to fix 
Change invite links to random strings like uuid in `UsersCollection.js`
```js
import uuid from 'uuid/v4';

async createChat (userCreator, name) {
        const chat = new Chat();
        chat.usersIds.push(userCreator);
        chat.name = name;
        chat.inviteLink = uuid();
        await chat.save();
        return chat.id;
    }
```


## 2 vuln
You can change chatId, after chat creation with `/editUser`
### [Exploit](./chat_admin.py)
### How to fix 

Add validation on chatId field in `ChatsCollection.js`.
```js
async editUser (oldUserModel, newFields) {
        for (const key of Object.keys(newFields)) {
            if (Object.prototype.hasOwnProperty.call(oldUserModel.toObject(), key) &&
                key !== 'id' &&
                key !== '_id' &&
                key !== '__v' &&
                key !== 'username' &&
                key !== 'chatId' &&
                key !== 'password') {
                oldUserModel[key] = newFields[key];
            }
        }
        return oldUserModel.save();
    }
```


## 3 vuln
Mongo injection

### [Exploit](./mongo_injection.py)

### How to fix
Add `.toString()` call in `index.js` on `/searchUser` route
```js
const foundedUser = await usersCollection
        .findByNameAndLastName({
            firstName: query.firstName.toString(),
            lastName: query.lastName.toString()
        })
        .catch(_ => {
            isSuccess = false;
        });
```
