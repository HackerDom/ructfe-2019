import sys
import asyncio

from user import User
from api import Api

ip = sys.argv[1]
url = f'http://{ip}:3000'


async def list_chats():
    async with Api(url) as api:
        resp = await api.get_chats()
    return resp['chats']


async def read_messages_from_admin_scenario(chats):
    for chat in chats:
        user = User()
        chat_id = chat['id']
        async with Api(url) as api:
            await api.register(user.get_register_data())
            await api.login(user.username, user.password)
            await api.join(chat_id, chat_id)
            resp = await api.read_messages(chat_id)
        if len(resp['messages']) > 0:
            print(resp['messages'])
            yield [x['text'] for x in resp['messages']]


async def main():
    chats = await list_chats()
    async for flags in read_messages_from_admin_scenario(chats):
        print(flags)


if __name__ == '__main__':
    asyncio.run(main())
